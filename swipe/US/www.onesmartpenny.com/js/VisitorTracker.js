(function(root,factory){if(typeof define==="function"&&define.amd){define(["jquery","jQuery-ajaxTransport-XDomainRequest"],factory)}else if(typeof exports==="object"){module.exports=factory(require("jquery"),require("jQuery-ajaxTransport-XDomainRequest"))}else{root.VisitorTracker=factory(root.$)}})(this,function($){"use strict";function VisitorTracker(){this.intervalId=0;this.visitorObject={};this.sessionObject={};this.environment="";this.ie=!($.support.cors||!$.ajaxTransport||!window.XDomainRequest);this.sessionCreated=false;this.sessionData=null;this.version="v1.3.0";function Visitor(){this.browser=null;this.device=null;this.ip_address=null;this.os=null}function Session(){this.utm_http_referer=null;this.click_Id2=null;this.utm_medium=null;this.utm_search_term=null;this.utm_sub5=null;this.utm_account=null;this.utm_trans=null;this.utm_content=null;this.utm_campaign=null;this.experiment_id=null;this.utm_adgroup=null;this.utm_creative_type=null;this.utm_publisher=null;this.utm_term=null;this.utm_lander=null;this.utm_placement=null;this.click_id=null;this.variation_id=null;this.host_name=null;this.utm_source=null;this.screen_size=null}function Event(){this.eventPayload={parent_event_id:null,lead_id:null,page_url:null,page_name:null,event_page:null,event_action:null,event_element:null,event_element_name:null,event_value:null,event_id:null,additional_properties:{},time_difference:null,createdAt:new Date};var discoverCount=0;this.parentObject=false;this.childrenList=[];$(this).on("event_idDefined",function(eventObject,data){this.set("event_id",data.event_id);this.addParentsToChildren();$(this).off("event_idDefined")});this.addParentsToChildren=function(){for(var i=0;i<this.childrenList.length;i++){var currentChildData=this.childrenList[i];currentChildData.set("parent_event_id",this.get("event_id"))}};this.get=function(dataToGet){if(!dataToGet||typeof dataToGet!=="string"){throw"dataToGet is not defined properly in get in Event "+"in VisitorTracker"}if(this.eventPayload[dataToGet]!==undefined){return this.eventPayload[dataToGet]}else{if(this.eventPayload.additional_properties[dataToGet]){return this.eventPayload[dataToGet].additional_properties}else{return undefined}}};this.set=function(dataToSet,valueToSet){if(!dataToSet||typeof dataToSet!=="string"){throw"dataToSet is not defined properly in get in Event "+"in VisitorTracker"}if((!valueToSet||typeof valueToSet!=="string")&&dataToSet!=="additional_properties"){throw"valueToSet is not defined properly in get in Event "+"in VisitorTracker"}if(this.eventPayload[dataToSet]!==undefined){this.eventPayload[dataToSet]=valueToSet}else{this.eventPayload.additional_properties[dataToSet]=valueToSet}}}this.init=function(addProps,environ,callback){this._setEnvironment(environ);this.sessionData=this._getSessionData();if(this.sessionData.vt_session_id){this.set("vt_session_id",this.sessionData.vt_session_id)}if(this.get("vt_session_id")){this._putSession(this.get("vt_session_id"),addProps,callback)}else{this._postSession(addProps,callback)}};this.set=function(key,val){try{if(window.localStorage){window.localStorage.setItem(key,val)}}catch(err){}};this.get=function(key){try{if(window.localStorage){return window.localStorage.getItem(key)}}catch(err){}return undefined};this._setEnvironment=function(environ){var staging="https://visitortracking.staging.billsdev.com/"+"visitortracking/";var production="https://t.freedomfinancialnetwork.com/"+"visitortracking/";var stagingList=["local","development","test","staging"];if(!environ||environ==="sandbox"){this.environment=staging}else{if(stagingList.join(",").indexOf(environ)>-1){this.environment=staging}else if(environ==="production"){this.environment=production}else{throw"environment is not properly defined in init for VisitorTracker"}}};this._getPageNameAndEventPage=function(eventToSend,addProps){if(!eventToSend){throw"eventToSend is not defined in _getPageNameAndEventPage"+" in VisitorTracker"}if(!addProps.page_name){eventToSend.page_name=window.location.protocol+window.location.host+window.location.pathname}if(!addProps.event_page){eventToSend.event_page=window.location.hash}return eventToSend};this._getSessionData=function(){var sessionToSend=new Session;var mappings={gclid:"click_id"};sessionToSend.host_name=window.location.hostname;sessionToSend.utm_http_referer=document.referrer;var splitByAmpersand=window.location.search.substring(1).split("&");for(var i=0;i<splitByAmpersand.length;i++){var pair=splitByAmpersand[i].split("=");var key=pair[0];var value=pair[1];if(mappings[key]){key=mappings[key]}sessionToSend[key]=value}return sessionToSend};this.trackEvent=function(eventToSend,addProps,callback){if(!eventToSend){throw"eventToSend is not defined properly in trackEvent"+" in VisitorTracker"}if(!addProps){throw"addProps is not defined properly in trackEvent in VisitorTracker"}else{if(addProps.lead_id){eventToSend.set("lead_id",addProps.lead_id)}if(addProps.event_element){eventToSend.set("event_element",addProps.event_element)}if(addProps.event_value){eventToSend.set("event_value",addProps.event_value)}if(addProps.event_element_name){eventToSend.set("event_element_name",addProps.event_element_name)}var predefined=["parent_event_id","lead_id","page_url","page_name","event_page","event_action","event_element","event_value"];for(var key in addProps){if(predefined.indexOf(key)===-1){eventToSend.set(key,addProps[key])}}this._postEvent(eventToSend,callback);return eventToSend}};this.defineEvent=function(typeOfEventToTrack,addProps,parentEvent,callback){var eventToReturn;if(parentEvent===null){}else if(parentEvent){var childIndex=parentEvent.childrenList.length;var temp=new Event;parentEvent.childrenList.push(temp);eventToReturn=parentEvent.childrenList[childIndex];eventToReturn.parentObject=parentEvent;if(parentEvent.get("event_id")){eventToReturn.set("parent_event_id",parentEvent.get("event_id"))}else{}}else{throw"parentEvent is not defined properly in trackEvent in VisitorTracker"}if(!eventToReturn){eventToReturn=new Event}eventToReturn.set("event_action",typeOfEventToTrack);if(!addProps.page_url){eventToReturn.set("page_url",window.location.href)}eventToReturn.eventPayload=this._getPageNameAndEventPage(eventToReturn.eventPayload,addProps);if(!addProps){throw"addProps is not defined properly in initEvent in VisitorTracker"}else{if(addProps.lead_id){eventToReturn.set("lead_id",addProps.lead_id)}if(addProps.event_element){eventToReturn.set("event_element",addProps.event_element)}if(addProps.event_value){eventToReturn.set("event_value",addProps.event_value)}if(addProps.event_element_name){eventToReturn.set("event_element_name",addProps.event_element_name)}var predefined=["parent_event_id","lead_id","event_action","event_element","event_value","event_element_value","time_difference","createdAt"];for(var key in addProps){if(predefined.indexOf(key)===-1){eventToReturn.set(key,addProps[key])}}if(typeof callback==="function"){callback(eventToReturn)}return eventToReturn}};this._ajaxCall=function(ajaxCallType,ajaxCallPath,dataToSend,doneCallback,callback){if(!ajaxCallType||!ajaxCallPath){throw"ajaxCallType or ajaxCallPath is not defined properly in "+"_ajaxCall in VisitorTracker"}var FFBillsApi=this.environment+ajaxCallPath;if(!dataToSend){throw"dataToSend is not defined properly in _ajaxCall in VisitorTracker"}if(ajaxCallType==="POST"&&ajaxCallPath==="events"){var currentTime=new Date;dataToSend.time_difference=currentTime.getTime()-dataToSend.createdAt.getTime()}var ajaxCallToMake={url:FFBillsApi,dataType:"json",method:ajaxCallType,crossDomain:true,xhrFields:{withCredentials:true}};if(ajaxCallType==="POST"||ajaxCallType==="PATCH"||ajaxCallType==="PUT"){ajaxCallToMake.data=JSON.stringify(dataToSend);ajaxCallToMake.contentType="application/json"}$.ajax(ajaxCallToMake).done($.proxy(function(data,textStatus,xhr){if(typeof doneCallback==="function"){doneCallback(data)}if(typeof callback==="function"){callback(null,data)}},this)).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;if(typeof callback==="function"){callback(err,null)}})};this._postSession=function(addProps,callback){if(!addProps){throw"addProps is not defined properly in _postSession"+"in VisitorTracker"}else{var ajaxCallType="POST";var ajaxCallPath="session";var previousSessionId;var previousVisitorId;var dataToSend=this.sessionData||this._getSessionData();if(this.ie){if(dataToSend.vt_session_id){this.set("vt_session_id",dataToSend.vt_session_id)}if(dataToSend.vt_visitor_id){this.set("vt_visitor_id",dataToSend.vt_visitor_id)}previousSessionId=this.get("vt_session_id");previousVisitorId=this.get("vt_visitor_id");if(previousSessionId){ajaxCallPath=ajaxCallPath+"/"+previousSessionId+"/ie?requesttype=Update"}else{ajaxCallPath=ajaxCallPath+"/ie"}if(previousVisitorId){dataToSend.visitor_id=previousVisitorId}}delete dataToSend.vt_visitor_id;delete dataToSend.vt_session_id;dataToSend.screen_size=screen.width+"x"+screen.height;dataToSend=this.merge({},dataToSend,addProps);var doneCallback=$.proxy(function(data){this.visitorObject=data.visitor;this.sessionObject=data.session;this.sessionCreated=true;this.set("vt_session_id",this.sessionObject.session_id);this.set("vt_visitor_id",this.visitorObject.visitor_id)},this);this._ajaxCall(ajaxCallType,ajaxCallPath,dataToSend,doneCallback,callback)}};this._putSession=function(sessionId,dataToPut,callback){if(!sessionId){throw"sessionId is not defined properly in _putSession"+"in VisitorTracker"}else if(!dataToPut){throw"dataToPut is not defined properly in _putSession"+"in VisitorTracker"}else{var ajaxCallType="PUT";var ajaxCallPath="session/"+sessionId;var dataToSend=this.merge({},this.sessionData||{},dataToPut);var doneCallback=$.proxy(function(data){this.sessionObject=data.session;this.sessionCreated=true;this.set("vt_session_id",this.sessionObject.session_id);this.set("vt_visitor_id",this.visitorObject.visitor_id)},this);if(this.ie){ajaxCallType="POST";ajaxCallPath+="/ie?requesttype=Update"}this._ajaxCall(ajaxCallType,ajaxCallPath,dataToSend,doneCallback,callback)}};this._postEvent=function(eventToSend,callback){if(this.sessionCreated===false){window.setTimeout($.proxy(function(){this._postEvent(eventToSend,callback)},this),100);return}if(!this.sessionObject){throw"cannot post an event without a session"}if(!eventToSend){throw"eventToSend is not defined properly in _postEvent in VisitorTracker"}var ajaxCallType="POST";var ajaxCallPath="events";var dataToSend=eventToSend.eventPayload;if(this.ie){ajaxCallPath+="/ie";dataToSend.session_id=this.sessionObject.session_id}else{ajaxCallPath+="/session/"+this.sessionObject.session_id}if(eventToSend.parentObject===false||eventToSend.get("parent_event_id")){var doneCallback=function(data){eventToSend.set("event_id",data.event_id);$(eventToSend).trigger("event_idDefined",[data])};this._ajaxCall(ajaxCallType,ajaxCallPath,dataToSend,doneCallback,callback)}else{var count=0;this.intervalId+=1;var ourInterval=this.intervalId;window["intervalVar"+ourInterval]=window.setInterval($.proxy(function(){if(count<3){if(eventToSend.eventPayload.parent_event_id){var doneCallback=function(data){eventToSend.set("event_id",data.event_id);$(eventToSend).trigger("event_idDefined",[data])};this._ajaxCall(ajaxCallType,ajaxCallPath,dataToSend,doneCallback,callback);count=3;window.clearInterval(window["intervalVar"+ourInterval])}else{count+=1}}else{count=3;window.clearInterval(window["intervalVar"+ourInterval])}},this),3e3)}};this.merge=function(target){if(target===undefined||target===null){throw new TypeError("Cannot convert undefined or null to object")}var output=Object(target);for(var index=1;index<arguments.length;index++){var source=arguments[index];if(source!==undefined&&source!==null){for(var nextKey in source){if(Object.prototype.hasOwnProperty.call(source,nextKey)){output[nextKey]=source[nextKey]}}}}return output}}return VisitorTracker});